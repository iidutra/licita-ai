{% extends "base.html" %}
{% load static widget_tweaks %}

{% block title %}{{ opp.title|truncatewords:8 }} â€” LicitaAI{% endblock %}

{% block content %}
<div data-opp-id="{{ opp.pk }}">

{# ===== HEADER ===== #}
<div class="detail-header">
  <a href="{% url 'opportunities:list' %}" class="text-muted fs-xs">&larr; Voltar para oportunidades</a>

  <div class="d-flex justify-content-between align-items-start mt-2 flex-wrap gap-2">
    <div style="min-width:0;flex:1;">
      <h4 id="opp-title" title="{{ opp.title }}">{{ opp.title }}</h4>
      <div class="detail-subtitle">
        {{ opp.entity_name }}{% if opp.entity_city %}, {{ opp.entity_city }}{% endif %}{% if opp.entity_uf %} ({{ opp.entity_uf }}){% endif %}
      </div>
      <div class="detail-chips">
        {% for chip in smart_chips %}
        <span class="chip chip-{{ chip.color }}">{% if chip.icon %}<i class="bi {{ chip.icon }}"></i>{% endif %}{{ chip.label }}</span>
        {% endfor %}
        {% if go_nogo %}
        <span class="gonogo gonogo-{{ go_nogo }}">
          <i class="bi {% if go_nogo == 'go' %}bi-check-circle-fill{% elif go_nogo == 'go_ressalvas' %}bi-exclamation-circle-fill{% else %}bi-x-circle-fill{% endif %}"></i>
          {% if go_nogo == 'go' %}GO{% elif go_nogo == 'go_ressalvas' %}GO COM RESSALVAS{% else %}NO-GO{% endif %}
        </span>
        {% endif %}
      </div>
    </div>

    <div class="detail-actions no-print">
      <form method="post" action="{% url 'opportunities:change_status' opp.pk %}" class="d-inline">
        {% csrf_token %}
        <select name="status" class="form-select form-select-sm" onchange="this.form.submit()" aria-label="Alterar status"
                style="width:auto;font-size:.78rem;">
          {% for val, label in opp.Status.choices %}
          <option value="{{ val }}" {% if opp.status == val %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </form>
      <button id="btn-copy" class="btn btn-outline-secondary btn-sm" type="button" title="Copiar link">
        <i class="bi bi-clipboard me-1"></i>Copiar
      </button>
      <a href="{% url 'opportunities:export_pdf' opp.pk %}" class="btn btn-outline-primary btn-sm" target="_blank">
        <i class="bi bi-file-earmark-pdf me-1"></i>PDF
      </a>
    </div>
  </div>
</div>

{# ===== KPI CARDS ===== #}
{% include "opportunities/_kpi_cards.html" %}

{# ===== COUNTDOWN ===== #}
{% if timeline.deadline %}
<div id="countdown" class="countdown urg-{{ timeline.urgency }}" data-deadline="{{ timeline.deadline_iso }}">
  <div>
    <div class="countdown-label">
      {% if timeline.urgency == 'expired' %}Prazo encerrado{% else %}Tempo restante{% endif %}
    </div>
    <div class="countdown-digits">
      <div class="cd-block"><span id="cd-days" class="cd-num">{{ timeline.delta_days|stringformat:"02d" }}</span><span class="cd-unit">dias</span></div>
      <div class="cd-block"><span id="cd-hours" class="cd-num">{{ timeline.delta_hours|stringformat:"02d" }}</span><span class="cd-unit">horas</span></div>
      <div class="cd-block"><span id="cd-mins" class="cd-num">00</span><span class="cd-unit">min</span></div>
      <div class="cd-block"><span id="cd-secs" class="cd-num">00</span><span class="cd-unit">seg</span></div>
    </div>
  </div>
  <div class="countdown-bar">
    <div class="countdown-bar-fill" style="width:{{ timeline.progress_pct }}%"></div>
  </div>
</div>
{% endif %}

{# ===== TABS ===== #}
<ul class="nav la-tabs mb-3 no-print" role="tablist">
  <li class="nav-item" role="presentation">
    <a class="nav-link active" data-bs-toggle="tab" href="#tab-overview" role="tab" aria-selected="true">Visao Geral</a>
  </li>
  <li class="nav-item" role="presentation">
    <a class="nav-link" data-bs-toggle="tab" href="#tab-checklist" role="tab">Checklist</a>
  </li>
  <li class="nav-item" role="presentation">
    <a class="nav-link" data-bs-toggle="tab" href="#tab-risks" role="tab">
      Riscos{% if risks %} <span class="badge bg-danger" style="font-size:.6rem;">{{ risks|length }}</span>{% endif %}
    </a>
  </li>
  <li class="nav-item" role="presentation">
    <a class="nav-link" data-bs-toggle="tab" href="#tab-evidence" role="tab">Evidencias</a>
  </li>
  <li class="nav-item" role="presentation">
    <a class="nav-link" data-bs-toggle="tab" href="#tab-items" role="tab">Itens ({{ items|length }})</a>
  </li>
  <li class="nav-item" role="presentation">
    <a class="nav-link" data-bs-toggle="tab" href="#tab-actions" role="tab">Acoes</a>
  </li>
</ul>

<div class="tab-content">

  {# ===== VISAO GERAL ===== #}
  <div class="tab-pane fade show active" id="tab-overview" role="tabpanel">
    {# Dados do Edital #}
    <div class="la-section">
      <div class="la-section-title">Dados do Edital</div>
      <div class="row">
        <div class="col-md-6">
          <table class="table table-sm mb-0" style="font-size:.82rem;">
            <tr><td class="fw-semibold text-muted" style="width:140px">Modalidade</td><td>{{ opp.get_modality_display }}</td></tr>
            <tr><td class="fw-semibold text-muted">Numero</td><td>{{ opp.number|default:"\u2014" }}</td></tr>
            <tr><td class="fw-semibold text-muted">Processo</td><td>{{ opp.process_number|default:"\u2014" }}</td></tr>
            <tr><td class="fw-semibold text-muted">CNPJ</td><td>{{ opp.entity_cnpj }}</td></tr>
            <tr><td class="fw-semibold text-muted">SRP</td><td>{{ opp.is_srp|yesno:"Sim,Nao" }}</td></tr>
          </table>
        </div>
        <div class="col-md-6">
          <table class="table table-sm mb-0" style="font-size:.82rem;">
            <tr><td class="fw-semibold text-muted" style="width:140px">Publicacao</td><td>{{ opp.published_at|date:"d/m/Y H:i"|default:"\u2014" }}</td></tr>
            <tr><td class="fw-semibold text-muted">Abertura</td><td>{{ opp.proposals_open_at|date:"d/m/Y H:i"|default:"\u2014" }}</td></tr>
            <tr><td class="fw-semibold text-muted">Encerramento</td><td>{{ opp.proposals_close_at|date:"d/m/Y H:i"|default:"\u2014" }}</td></tr>
            <tr><td class="fw-semibold text-muted">Prazo Final</td><td>{{ opp.deadline|date:"d/m/Y H:i"|default:"\u2014" }}</td></tr>
            {% if opp.link %}
            <tr><td class="fw-semibold text-muted">Origem</td><td><a href="{{ opp.link }}" target="_blank" rel="noopener">Abrir <i class="bi bi-box-arrow-up-right" style="font-size:.7rem;"></i></a></td></tr>
            {% endif %}
          </table>
        </div>
      </div>
    </div>

    {# Descricao #}
    {% if opp.description %}
    <div class="la-section">
      <div class="la-section-title">Objeto / Descricao</div>
      <p class="mb-0" style="font-size:.85rem;color:#334155;">{{ opp.description }}</p>
    </div>
    {% endif %}

    {# AI Summary (partial) #}
    {% include "opportunities/_ai_summary.html" %}

    {# Matches #}
    {% if matches %}
    <div class="la-section">
      <div class="la-section-title">Matching com Clientes</div>
      <table class="table table-sm mb-0" style="font-size:.82rem;">
        <thead><tr><th>Cliente</th><th>Score</th><th>Justificativa</th></tr></thead>
        <tbody>
          {% for m in matches %}
          <tr>
            <td><a href="{% url 'clients:detail' m.client.pk %}">{{ m.client.name }}</a></td>
            <td>
              <span class="{% if m.score >= 70 %}score-high{% elif m.score >= 40 %}score-mid{% else %}score-low{% endif %}">
                {{ m.score }}/100
              </span>
            </td>
            <td class="text-muted">{{ m.justification|truncatewords:30 }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% endif %}
  </div>

  {# ===== CHECKLIST ===== #}
  <div class="tab-pane fade" id="tab-checklist" role="tabpanel">
    <div class="la-section">
      {% if checklist_groups %}
        {% for group in checklist_groups %}
        <div class="chk-group-title">{{ group.category }}</div>
        {% for item in group.items %}
        <div class="chk-item">
          <input type="checkbox" data-req-id="{{ item.id }}" id="chk-{{ item.id }}">
          <label for="chk-{{ item.id }}" class="chk-text mb-0" style="cursor:pointer;">{{ item.text }}</label>
          {% if item.mandatory %}<span class="chk-mandatory">Obrigatorio</span>{% endif %}
        </div>
        {% endfor %}
        {% endfor %}
      {% else %}
        <div class="empty-state">
          <i class="bi bi-list-check d-block"></i>
          <p>Nenhum requisito extraido.</p>
          <span class="text-muted fs-xs">Use "Rodar IA" na aba Acoes</span>
        </div>
      {% endif %}
    </div>
  </div>

  {# ===== RISCOS ===== #}
  <div class="tab-pane fade" id="tab-risks" role="tabpanel">
    <div class="la-section">
      {% if risks %}
        {% for risk in risks %}
        <div class="risk-card {{ risk.severidade }}">
          <div class="risk-header">
            {{ risk.tipo|upper }}
            <span class="sev-badge {{ risk.severidade }} ms-2">{{ risk.severidade }}</span>
          </div>
          <div class="risk-body">{{ risk.descricao }}</div>
          {% if risk.evidencia.trecho %}
          <div class="risk-evidence">"{{ risk.evidencia.trecho|truncatewords:40 }}"</div>
          {% endif %}
        </div>
        {% endfor %}
      {% else %}
        <div class="empty-state">
          <i class="bi bi-shield-check d-block"></i>
          <p>Nenhum risco identificado.</p>
          <span class="text-muted fs-xs">Use "Rodar IA" na aba Acoes</span>
        </div>
      {% endif %}
    </div>
  </div>

  {# ===== EVIDENCIAS ===== #}
  <div class="tab-pane fade" id="tab-evidence" role="tabpanel">
    <div class="la-section">
      <div class="la-section-title">Documentos</div>
      <table class="table table-sm mb-0" style="font-size:.82rem;">
        <thead><tr><th>Arquivo</th><th>Tipo</th><th>Status</th><th>Paginas</th><th>OCR</th></tr></thead>
        <tbody>
          {% for doc in documents %}
          <tr>
            <td>
              {{ doc.file_name|default:"\u2014" }}
              {% if doc.original_url %}<a href="{{ doc.original_url }}" target="_blank" rel="noopener" class="ms-1"><i class="bi bi-link-45deg"></i></a>{% endif %}
            </td>
            <td>{{ doc.doc_type|default:"\u2014" }}</td>
            <td><span class="badge bg-secondary" style="font-size:.65rem;">{{ doc.get_processing_status_display }}</span></td>
            <td>{{ doc.page_count|default:"\u2014" }}</td>
            <td>{{ doc.ocr_used|yesno:"Sim,Nao" }}</td>
          </tr>
          {% empty %}
          <tr><td colspan="5">
            <div class="empty-state py-3">
              <i class="bi bi-file-earmark d-block"></i>
              <p>Nenhum documento.</p>
            </div>
          </td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  {# ===== ITENS ===== #}
  <div class="tab-pane fade" id="tab-items" role="tabpanel">
    <div class="la-section">
      <table class="table table-sm mb-0" style="font-size:.82rem;">
        <thead><tr><th>#</th><th>Descricao</th><th>Qtde</th><th>Unid.</th><th class="text-end">P. Unit. Est.</th><th class="text-end">Total Est.</th></tr></thead>
        <tbody>
          {% for item in items %}
          <tr>
            <td class="text-muted">{{ item.item_number }}</td>
            <td>{{ item.description|truncatewords:20 }}</td>
            <td>{{ item.quantity|default:"\u2014" }}</td>
            <td>{{ item.unit }}</td>
            <td class="text-end">{% if item.estimated_unit_price %}R$ {{ item.estimated_unit_price|floatformat:2 }}{% else %}&mdash;{% endif %}</td>
            <td class="text-end fw-semibold">{% if item.estimated_total %}R$ {{ item.estimated_total|floatformat:2 }}{% else %}&mdash;{% endif %}</td>
          </tr>
          {% empty %}
          <tr><td colspan="6">
            <div class="empty-state py-3">
              <i class="bi bi-list-ol d-block"></i>
              <p>Nenhum item.</p>
            </div>
          </td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  {# ===== ACOES ===== #}
  <div class="tab-pane fade" id="tab-actions" role="tabpanel">
    <div class="row g-3">
      <div class="col-md-6">
        <div class="la-section">
          <div class="la-section-title"><i class="bi bi-robot me-1"></i>Rodar IA</div>
          <form method="post" action="{% url 'opportunities:run_ai' opp.pk %}">
            {% csrf_token %}
            <div class="mb-3">
              <label class="form-label" style="font-size:.8rem;">Tipo de analise</label>
              {{ ai_form.analysis_type|add_class:"form-select form-select-sm" }}
            </div>
            <button type="submit" class="btn btn-primary btn-sm">
              <i class="bi bi-play-fill me-1"></i>Executar
            </button>
          </form>
        </div>
      </div>
      <div class="col-md-6">
        <div class="la-section">
          <div class="la-section-title"><i class="bi bi-arrow-left-right me-1"></i>Rodar Matching</div>
          <form method="post" action="{% url 'opportunities:run_matching' opp.pk %}">
            {% csrf_token %}
            <div class="mb-3">
              <label class="form-label" style="font-size:.8rem;">Cliente</label>
              {{ matching_form.client|add_class:"form-select form-select-sm" }}
            </div>
            <button type="submit" class="btn btn-success btn-sm">
              <i class="bi bi-play-fill me-1"></i>Executar
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

</div>{# /tab-content #}
</div>{# /data-opp-id #}
{% endblock %}
